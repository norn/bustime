(function(d){d.fn.extend({autocomplete:function(a,c){var q="string"==typeof a;c=d.extend({},d.Autocompleter.defaults,{url:q?a:null,data:q?null:a,delay:q?d.Autocompleter.defaults.delay:10,max:c&&!c.scroll?10:150},c);c.highlight=c.highlight||function(a){return a};c.formatMatch=c.formatMatch||c.formatItem;return this.each(function(){new d.Autocompleter(this,c)})},result:function(a){return this.bind("result",a)},search:function(a){return this.trigger("search",[a])},flushCache:function(){return this.trigger("flushCache")},
setOptions:function(a){return this.trigger("setOptions",[a])},unautocomplete:function(){return this.trigger("unautocomplete")}});d.Autocompleter=function(a,c){function q(){var v=p.selected();if(!v)return!1;var b=v.result;u=b;if(c.multiple){var n=s(h.val());if(1<n.length){var e=c.multipleSeparator.length,k=d(a).selection().start,f,g=0;d.each(n,function(a,c){g+=c.length;if(k<=g)return f=a,!1;g+=e});n[f]=b;b=n.join(c.multipleSeparator)}b+=c.multipleSeparator}h.val(b);m();h.trigger("result",[v.data,v.value]);
return!0}function l(a,d){if(n==b.DEL)p.hide();else{var f=h.val();if(d||f!=u)u=f,f=g(f),f.length>=c.minChars?(h.addClass(c.loadingClass),c.matchCase||(f=f.toLowerCase()),e(f,k,m)):(h.removeClass(c.loadingClass),p.hide())}}function s(a){return a?c.multiple?d.map(a.split(c.multipleSeparator),function(c){return d.trim(a).length?d.trim(c):null}):[d.trim(a)]:[""]}function g(b){if(!c.multiple)return b;var n=s(b);if(1==n.length)return n[0];n=d(a).selection().start;n=n==b.length?s(b):s(b.replace(b.substring(n),
""));return n[n.length-1]}function m(){p.visible();p.hide();clearTimeout(t);h.removeClass(c.loadingClass);c.mustMatch&&(""==h.val()?h.removeClass("ac_wrongvalue"):h.search(function(a){a||(c.multiple?(a=s(h.val()).slice(0,-1),h.val(a.join(c.multipleSeparator)+(a.length?c.multipleSeparator:""))):(h.hasClass("ac_wrongvalue")||h.addClass("ac_wrongvalue"),h.trigger("result",null)))}))}function k(e,k){if(k&&k.length&&f){h.removeClass(c.loadingClass);p.display(k,e);var t=k[0].value;c.autoFill&&g(h.val()).toLowerCase()==
e.toLowerCase()&&n!=b.BACKSPACE&&(h.val(h.val()+t.substring(g(u).length)),d(a).selection(u.length,u.length+t.length));p.show();c.mustMatch&&h.removeClass("ac_wrongvalue")}else m()}function e(b,n,e){c.matchCase||(b=b.toLowerCase());var k=r.load(b);if(k&&k.length)n(b,k);else if("string"==typeof c.url&&0<c.url.length){var f={timestamp:+new Date};d.each(c.extraParams,function(a,b){f[a]="function"==typeof b?b():b});d.ajax({mode:"abort",port:"autocomplete"+a.name,dataType:c.dataType,url:c.url,data:d.extend({q:g(b),
limit:c.max},f),success:function(a){var e;if(!(e=c.parse&&c.parse(a))){e=[];a=a.split("\n");for(var k=0;k<a.length;k++){var f=d.trim(a[k]);f&&(f=f.split("|"),e[e.length]={data:f,value:f[0],result:c.formatResult&&c.formatResult(f,f[0])||f[0]})}}r.add(b,e);n(b,e)}})}else p.emptyList(),e(b)}var b={UP:38,DOWN:40,DEL:46,TAB:9,RETURN:13,ESC:27,COMMA:188,PAGEUP:33,PAGEDOWN:34,BACKSPACE:8},h=d(a).attr("autocomplete","off").addClass(c.inputClass),t,u="",r=d.Autocompleter.Cache(c),f=0,n,x={mouseDownOnSelect:!1},
p=d.Autocompleter.Select(c,a,q,x),w;d.browser.opera&&d(a.form).bind("submit.autocomplete",function(){if(w)return w=!1});h.bind((d.browser.opera?"keypress":"keydown")+".autocomplete",function(a){f=1;n=a.keyCode;switch(a.keyCode){case b.UP:a.preventDefault();p.visible()?p.prev():l(0,!0);break;case b.DOWN:a.preventDefault();p.visible()?p.next():l(0,!0);break;case b.PAGEUP:a.preventDefault();p.visible()?p.pageUp():l(0,!0);break;case b.PAGEDOWN:a.preventDefault();p.visible()?p.pageDown():l(0,!0);break;
case c.multiple&&","==d.trim(c.multipleSeparator)&&b.COMMA:case b.TAB:case b.RETURN:if(q())return a.preventDefault(),w=!0,!1;break;case b.ESC:p.hide();break;default:clearTimeout(t),t=setTimeout(l,c.delay)}}).focus(function(){f++}).blur(function(){f=0;x.mouseDownOnSelect||(clearTimeout(t),t=setTimeout(m,200))}).click(function(){1<f++&&!p.visible()&&l(0,!0)}).bind("search",function(){function a(c,n){var e;if(n&&n.length)for(var f=0;f<n.length;f++)if(n[f].result.toLowerCase()==c.toLowerCase()){e=n[f];
break}"function"==typeof b?b(e):h.trigger("result",e&&[e.data,e.value])}var b=1<arguments.length?arguments[1]:null;d.each(s(h.val()),function(b,c){e(c,a,a)})}).bind("flushCache",function(){r.flush()}).bind("setOptions",function(a,b){d.extend(c,b);"data"in b&&r.populate()}).bind("unautocomplete",function(){p.unbind();h.unbind();d(a.form).unbind(".autocomplete")})};d.Autocompleter.defaults={inputClass:"ac_input",resultsClass:"ac_results",loadingClass:"ac_loading",minChars:1,delay:400,matchCase:!1,matchSubset:!0,
matchContains:!1,cacheLength:10,max:100,mustMatch:!1,extraParams:{},selectFirst:!0,formatItem:function(a){return a[0]},formatMatch:null,autoFill:!1,width:0,multiple:!1,multipleSeparator:", ",highlight:function(a,c){return a.replace(RegExp("(?![^&;]+;)(?!<[^<>]*)("+c.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:!0,scrollHeight:180};d.Autocompleter.Cache=function(a){function c(c,e){a.matchCase||(c=c.toLowerCase());var b=c.indexOf(e);
"word"==a.matchContains&&(b=c.toLowerCase().search("\\b"+e.toLowerCase()));return-1==b?!1:0==b||a.matchContains}function q(c,e){m>a.cacheLength&&s();g[c]||m++;g[c]=e}function l(){if(!a.data)return!1;var c={},e=0;a.url||(a.cacheLength=1);c[""]=[];for(var b=0,h=a.data.length;b<h;b++){var g=a.data[b],g="string"==typeof g?[g]:g,m=a.formatMatch(g,b+1,a.data.length);if(!1!==m){var l=m.charAt(0).toLowerCase();c[l]||(c[l]=[]);g={value:m,data:g,result:a.formatResult&&a.formatResult(g)||m};c[l].push(g);e++<
a.max&&c[""].push(g)}}d.each(c,function(c,b){a.cacheLength++;q(c,b)})}function s(){g={};m=0}var g={},m=0;setTimeout(l,25);return{flush:s,add:q,populate:l,load:function(k){if(!a.cacheLength||!m)return null;if(!a.url&&a.matchContains){var e=[],b;for(b in g)if(0<b.length){var h=g[b];d.each(h,function(a,b){c(b.value,k)&&(isNaN(parseFloat(b.value.charAt(0)))?e.unshift(b):e.push(b))})}return e}if(g[k])return g[k];if(a.matchSubset)for(b=k.length-1;b>=a.minChars;b--)if(h=g[k.substr(0,b)])return e=[],d.each(h,
function(a,b){c(b.value,k)&&(e[e.length]=b)}),e;return null}}};d.Autocompleter.Select=function(a,c,q,l){function s(){u&&(r=d("<div/>").hide().addClass(a.resultsClass).css("position","absolute").appendTo(document.body),f=d("<ul/>").appendTo(r).mouseover(function(a){g(a).nodeName&&"LI"==g(a).nodeName.toUpperCase()&&(b=d("li",f).removeClass(k.ACTIVE).index(g(a)),d(g(a)).addClass(k.ACTIVE))}).click(function(a){d(g(a)).addClass(k.ACTIVE);q();c.focus();return!1}).mousedown(function(){l.mouseDownOnSelect=
!0}).mouseup(function(){l.mouseDownOnSelect=!1}),0<a.width&&r.css("width",a.width),u=!1)}function g(a){for(a=a.target;a&&"LI"!=a.tagName;)a=a.parentNode;return a?a:[]}function m(c){e.slice(b,b+1).removeClass(k.ACTIVE);b+=c;0>b?b=e.size()-1:b>=e.size()&&(b=0);c=e.slice(b,b+1).addClass(k.ACTIVE);if(a.scroll){var d=0;e.slice(0,b).each(function(){d+=this.offsetHeight});d+c[0].offsetHeight-f.scrollTop()>f[0].clientHeight?f.scrollTop(d+c[0].offsetHeight-f.innerHeight()):d<f.scrollTop()&&f.scrollTop(d)}}
var k={ACTIVE:"ac_over"},e,b=-1,h,t="",u=!0,r,f;return{display:function(c,g){s();h=c;t=g;f.empty();var m;m=h.length;m=a.max&&a.max<m?a.max:m;for(var l=0;l<m;l++)if(h[l]){var q=a.formatItem(h[l].data,l+1,m,h[l].value,t);!1!==q&&(q=d("<li/>").html(a.highlight(q,t)).addClass(0==l%2?"ac_even":"ac_odd").appendTo(f)[0],d.data(q,"ac_data",h[l]))}e=f.find("li");a.selectFirst&&(e.slice(0,1).addClass(k.ACTIVE),b=0);d.fn.bgiframe&&f.bgiframe()},next:function(){m(1)},prev:function(){m(-1)},pageUp:function(){0!=
b&&0>b-8?m(-b):m(-8)},pageDown:function(){b!=e.size()-1&&b+8>e.size()?m(e.size()-1-b):m(8)},hide:function(){r&&r.hide();e&&e.removeClass(k.ACTIVE);b=-1},visible:function(){return r&&r.is(":visible")},current:function(){return this.visible()&&(e.filter("."+k.ACTIVE)[0]||a.selectFirst&&e[0])},show:function(){var b=d(c).offset();r.css({width:"string"==typeof a.width||0<a.width?a.width:d(c).width(),top:b.top+c.offsetHeight,left:b.left}).show();if(a.scroll&&(f.scrollTop(0),f.css({maxHeight:a.scrollHeight,
overflow:"auto"}),d.browser.msie&&"undefined"===typeof document.body.style.maxHeight)){var g=0;e.each(function(){g+=this.offsetHeight});b=g>a.scrollHeight;f.css("height",b?a.scrollHeight:g);b||e.width(f.width()-parseInt(e.css("padding-left"))-parseInt(e.css("padding-right")))}},selected:function(){var a=e&&e.filter("."+k.ACTIVE).removeClass(k.ACTIVE);return a&&a.length&&d.data(a[0],"ac_data")},emptyList:function(){f&&f.empty()},unbind:function(){r&&r.remove()}}};d.fn.selection=function(a,c){if(void 0!==
a)return this.each(function(){if(this.createTextRange){var d=this.createTextRange();void 0===c||a==c?d.move("character",a):(d.collapse(!0),d.moveStart("character",a),d.moveEnd("character",c));d.select()}else this.setSelectionRange?this.setSelectionRange(a,c):this.selectionStart&&(this.selectionStart=a,this.selectionEnd=c)});var d=this[0];if(d.createTextRange){var l=document.selection.createRange(),s=d.value,g=l.text.length;l.text="<->";l=d.value.indexOf("<->");d.value=s;this.selection(l,l+g);return{start:l,
end:l+g}}if(void 0!==d.selectionStart)return{start:d.selectionStart,end:d.selectionEnd}}})(jQuery);